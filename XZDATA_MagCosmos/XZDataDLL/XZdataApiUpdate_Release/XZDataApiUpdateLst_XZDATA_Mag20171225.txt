XZDATA_Mag20210812
2021/8/13§ó·s----------------------------------------------------------------------

¥»¦¸¾÷¯à½Õ¾ã­«ÂI
¤@¡B	±bªí¡@
(1)	¹w°â§I´«°Ó«~²£¥ÍªºÀô«OªMª÷ÃB¡A­ì¤J±bªíªº¥N°â°Ó«~§éÅýª÷ÃB¡A§ï¤J[§é¦©(À³µ|)]¡C
ƒÜ	­ì¥»§PÂ_1010¹w°â§I´«ªº°O¿ýÀô«OªMª÷ÃB±a¤J±bªí[¥N°â°Ó«~§éÅýª÷ÃB]¡A§ï±a¤J±bªí[§é¦©(À³µ|)] ¡C
ref:Àô«OªM¥N°â°Ó«~§éÅý§ï­p¤J§é¦©(À³µ|).txt

(¶È¦C¥X¨ç¦¡¸Ì¦³­×§ïªº¨º´X¦æ,¨ä¥L¬Ù²¤¨S¶K¤W¨Ó)
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
¤@¡C
int __fastcall XDATA::GetXDTData(String StrZCnt, String StoreNO,  String EcrNO, String SalesNo, String XDTsysDttm, String StrNxnoSeq,
                          String Version, String Z_date, String DDZ_1099, String ZNT_1099, String sIdx,
                          String &RtnXDTData, String &RtnXRPFile, String &RtnCRPFile )
{
    //sTmp.sprintf("%08d",iPreSalINVODisAmt);
    sTmp.sprintf("%08d",0);                     //¥N°â°Ó«~§éÅýª÷ÃB 0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]):¹w°â§I´«ªºÀô«OªM­ì­p¤J¥N°â°Ó«~§éÅýª÷ÃB,§ï­p¤J§é¦©(À³µ|)
    x_f += (sTmp+"|");                           // ¥N°â°Ó«~§éÅýª÷ÃB  ­É¹s¦X­pª÷ÃB

(¤¤¶¡¬Ù²¤)

    //x_i += (x->tb_casher.am_dise.sprintf("%08d", giB+iPreSalMMDisAmt_MFP - iPreSalINVODisAmt)+"|");                 //§é¦©ª÷ÃB ¤£§t§éÅý³æ : iPreSalINVODisAmt
    x_i += (x->tb_casher.am_dise.sprintf("%08d", giB+iPreSalMMDisAmt_MFP)+"|");                 //§é¦©ª÷ÃB,§ï¦¨¥]§t¹w°â§I´«Àô«OªM§éÅý(0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]))
}





///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
¤G¡C
int __fastcall ZDATA::GetZDTData(String StrZCnt, String StoreNO,  String EcrNO, String SalesNo ,
                          String Version, String PZ_date, String Z_date, String DDZ_1099, String ZDT_1050,
                          String &RtnZDTData, AnsiString &Tclsacc,
                          String &str_zrp_path, String &str_dpt_path)
{
    //sTmp.sprintf("%08d",iPreSalINVODisAmt);
    sTmp.sprintf("%08d",0);                       //¥N°â°Ó«~§éÅýª÷ÃB 0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]):¹w°â§I´«ªºÀô«OªM­ì­p¤J¥N°â°Ó«~§éÅýª÷ÃB,§ï­p¤J§é¦©(À³µ|)
    z_h += (sTmp+"|");                           // ¥N°â°Ó«~§éÅý³æª÷ÃB

(¤¤¶¡¬Ù²¤)

    //z_h += (z->tb_casher.am_disc.sprintf("%08d", giB+iPreSalMMDisAmt_MFP - iPreSalINVODisAmt)+"|");            // §é¦©ª÷ÃB(À³µ|)
    z_h += (z->tb_casher.am_disc.sprintf("%08d", giB+iPreSalMMDisAmt_MFP)+"|");            // §é¦©ª÷ÃB(À³µ|),§ï¦¨¥]§t¹w°â§I´«Àô«OªM§éÅý(0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]))
}





///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
¤T¡C
//X±bªí  Åª±b
int __fastcall XREPORT::WriteData( const String StoreNO, const String EcrNO, const String SalesNo ,
                                   const AnsiString SalFileName, const AnsiString Version)
{
    //sTmp.sprintf("%08d",iPreSalINVODisAmt);
    sTmp.sprintf("%08d",0);                       //¥N°â°Ó«~§éÅýª÷ÃB 0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]):¹w°â§I´«ªºÀô«OªM­ì­p¤J¥N°â°Ó«~§éÅýª÷ÃB,§ï­p¤J§é¦©(À³µ|)
    xr_h += (sTmp+"|");                           // ¥N¦¬°Ó«~§éÅý³æ§é¦©  ­É¹s¦X­pª÷ÃB

(¤¤¶¡¬Ù²¤)

    //xr_h += (xr->tb_casher.am_disc.sprintf("%08d",giB+iPreSalMMDisAmt_MFP - iPreSalINVODisAmt)+"|");             // §é¦©ª÷ÃB(À³µ|)   62
    xr_h += (xr->tb_casher.am_disc.sprintf("%08d",giB+iPreSalMMDisAmt_MFP)+"|");             // §é¦©ª÷ÃB(À³µ|)   62 ,§ï¦¨¥]§t¹w°â§I´«Àô«OªM§éÅý(0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]))
}






///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
¥|¡C
//¾á·í¦P¥æ¯Z
int __fastcall CHECKIN::WriteData(const String StoreNO, const String EcrNO, const String SalesNo ,
                                const String SalFileName, const String Version)
{
    //sTmp.sprintf("%08d",iPreSalINVODisAmt);
    sTmp.sprintf("%08d",0);             //¥N°â°Ó«~§éÅýª÷ÃB 0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]):¹w°â§I´«ªºÀô«OªM­ì­p¤J¥N°â°Ó«~§éÅýª÷ÃB,§ï­p¤J§é¦©(À³µ|)
    x_f += (sTmp+"|");                           // ¥N°â°Ó«~§éÅýª÷ÃB  ­É¹s¦X­pª÷ÃB

(¤¤¶¡¬Ù²¤)

    //x_i += (x->tb_casher.am_dise.sprintf("%08d", giB+iPreSalMMDisAmt_MFP - iPreSalINVODisAmt)+"|");                 //§é¦©ª÷ÃB
    x_i += (x->tb_casher.am_dise.sprintf("%08d", giB+iPreSalMMDisAmt_MFP)+"|");        //§é¦©ª÷ÃB(À³µ|),§ï¦¨¥]§t¹w°â§I´«Àô«OªM§éÅý(0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]))
}





///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
¤­¡C
//½LÂI¤H­ûÅª±b   call by _WVXZ
int __fastcall VXZDATA::WriteData(const String StoreNO, const String EcrNO, const String SalesNo ,
                                const String SalFileName, const String Version)
{
    //sTmp.sprintf("%08d",iPreSalINVODisAmt);
    sTmp.sprintf("%08d",0);                                       //¥N°â°Ó«~§éÅýª÷ÃB 0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]):¹w°â§I´«ªºÀô«OªM­ì­p¤J¥N°â°Ó«~§éÅýª÷ÃB,§ï­p¤J§é¦©(À³µ|)
    z_h += (sTmp+"|");                                            // ¥N°â°Ó«~§éÅýª÷ÃB  ­É¹s¦X­pª÷ÃB

(¤¤¶¡¬Ù²¤)

    //z_h += (z->tb_casher.am_disc.sprintf("%08d", giB+iPreSalMMDisAmt_MFP - iPreSalINVODisAmt)+"|");            // §é¦©ª÷ÃB(À³µ|)
    z_h += (z->tb_casher.am_disc.sprintf("%08d", giB+iPreSalMMDisAmt_MFP)+"|");            // §é¦©ª÷ÃB(À³µ|),§ï¦¨¥]§t¹w°â§I´«Àô«OªM§éÅý(0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]))
}







///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
¤»¡C
int __fastcall AUTOZDATA::GetZDTData(String StrZCnt, String StoreNO,  String EcrNO, String SalesNo ,
                          String Version, String PZ_date, String Z_date, String DDZ_1099, String ZDT_1050,
                          String &RtnZDTData, AnsiString &Tclsacc,
                          String &str_zrp_path, String &str_dpt_path)
{
    //sTmp.sprintf("%08d",iPreSalINVODisAmt);
    sTmp.sprintf("%08d",0);                                       //¥N°â°Ó«~§éÅýª÷ÃB 0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]):¹w°â§I´«ªºÀô«OªM­ì­p¤J¥N°â°Ó«~§éÅýª÷ÃB,§ï­p¤J§é¦©(À³µ|)
    z_h += (sTmp+"|");                                            // ¥N°â°Ó«~§éÅýª÷ÃB  ­É¹s¦X­pª÷

(¤¤¶¡¬Ù²¤)

    //z_h += (z->tb_casher.am_disc.sprintf("%08d", giB+iPreSalMMDisAmt_MFP - iPreSalINVODisAmt)+"|");            // §é¦©ª÷ÃB(À³µ|)
    z_h += (z->tb_casher.am_disc.sprintf("%08d", giB+iPreSalMMDisAmt_MFP)+"|");            // §é¦©ª÷ÃB(À³µ|),§ï¦¨¥]§t¹w°â§I´«Àô«OªM§éÅý(0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]))
}







///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
¤C¡C
//¦Û°Ê¦¬»È­û¥æ¯Z
AnsiString __fastcall AUTOZDATA::AutoXData(const String StoreNO, const String EcrNO, const String SalesNo ,
                                const String SalFileName, const String Version, const AnsiString AutoZ_cnt,
                                const AnsiString AutoZ_Dt )
{
    //sTmp.sprintf("%08d",iPreSalINVODisAmt);
    sTmp.sprintf("%08d",0);                      //¥N°â°Ó«~§éÅýª÷ÃB 0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]):¹w°â§I´«ªºÀô«OªM­ì­p¤J¥N°â°Ó«~§éÅýª÷ÃB,§ï­p¤J§é¦©(À³µ|)
    x_f += (sTmp+"|");                           // ¥N°â°Ó«~§éÅýª÷ÃB  ­É¹s¦X­pª÷ÃB

(¤¤¶¡¬Ù²¤)

    //x_i += (x->tb_casher.am_dise.sprintf("%08d", giB+iPreSalMMDisAmt_MFP - iPreSalINVODisAmt)+"|");         //§é¦©ª÷ÃB(À³µ|)
    x_i += (x->tb_casher.am_dise.sprintf("%08d", giB+iPreSalMMDisAmt_MFP)+"|");         //§é¦©ª÷ÃB(À³µ|),§ï¦¨¥]§t¹w°â§I´«Àô«OªM§éÅý(0034576: (TMSCÀô«OªMÂàÀxfami¿ú¥]))
}


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

















XZDATA_Mag20210615
2021/6/24§ó·s----------------------------------------------------------------------

1."²¼¨é°h²¼±i¼Æ"§ï¦¨"¹º¦ì²¼¨é°h²¼±i¼Æ"(¤â°Ê&¦Û°Ê¤éµ²2­Ó¦a¤è)
2."²¼¨é°h²¼±i¼Æ"&"«H¥Î¥dÃ±³æ±i¼Æ"¦ì¸m²¾¨ì"´£³f¨é±i¼Æ"¤U(¤â°Ê&¦Û°Ê¤éµ²2­Ó¦a¤è)
3.log¸É¤W¨ç¦¡¦WºÙ¡GRtn_Ticket:¹º¦ì²¼¨é°h²¼±i¼Æ
ref:²¼¨é°h²¼±i¼Æ.txt


XZDATA_Mag20210601

¶³ºÝ¤¤¼úµo²¼·s¼W¼ú¶µ800¤¸

§ë®w1041   ¶³ºÝ800ªº¤¤¼úª÷ÃB  ¼g¤J  1041. AM_PAY_GROUP Äæ¦ì  

int __fastcall BASIC::SumCasherRpt
int __fastcall BASIC::SumCasherRptXDT

{

pay_other1_amt=pay_other2_amt=ipay_CldInvo800_amt=0;


//Cloud ¤¤¼úµo²¼ª÷ÃB(800)  20210601 Update
            ipay_CldInvo800_amt  += _StrToInt(_StringSegment_EX(s, "|", 18));

//1041|¹q¤å
ipay_CldInvo800_amt, //pay_group_amt,//Cloud ¤¤¼úµo²¼ª÷ÃB(800) ipay_CldInvo800_amt  20210601 Update




int itotWinInvoAmt41=(iacc_invo_amt+pay_other1_amt+pay_other2_amt+ipay_CldInvo800_amt)-iWinnInvoAmt; 


 //Cloud ¤¤¼úµo²¼ª÷ÃB(800) ipay_CldInvo800_amt  20210601 Update
   strtmp=AutoCrpIni->ReadString("AutoX","invo800","0");
   i1=_StrToInt(_StringSegment_EX(strtmp, "|", 2));
   i2=_StrToInt(_StringSegment_EX(strtmp, "|", 3));

   strtmp.sprintf("%s  ¡Ï¤¤¼úµo²¼ª÷ÃB(800¤¸) :%7ld",CmdStr.c_str(),ipay_CldInvo800_amt+i2);  tslCrp->Add(strtmp);

   if( Update )
     {
      if( iAutoZ )
        strtmp.sprintf("¤¤¼ú800|%02d|%8ld|", 0, ipay_CldInvo800_amt+i2);
      else
        strtmp.sprintf("¤¤¼ú800|%02d|%8ld|", 0, 0);
      AutoCrpIni->WriteString("AutoX","invo800",strtmp);
    }




strtmp.sprintf("%s  §ë®w¤p­p         :   %8ld\n",CmdStr.c_str(),ipay_cash_amt+ipay_present_amt+ipay_cpn_amt+
                  ipay_CldInvo800_amt+iacc_invo_amt+pay_other1_amt+pay_other2_amt+itot_acc_amt+i2);   tslCrp->Add(strtmp);


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////


}


//////////////////////////////////////////////////
//¾á·í¦P¥æ¯Z
int __fastcall CHECKIN::WriteData(const String StoreNO, const String EcrNO, const String SalesNo ,
                                const String SalFileName, const String Version)


//¤¤¼úµo²¼ª÷ÃB  800   Cloud ¤¤¼úµo²¼ª÷ÃB(800)   20210601 Update
        int_drop_money += _StrToInt( _StringSegment_EX(s, "|", 18) );


//µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼±i¼Æ  ª÷ÃB
    VoicePayAmt(0,gi_tot_line);
    sTmp.sprintf("%08d|",giA/200); //µo²¼§I¼ú±i¼Æ
    x_h +=sTmp;
    sTmp.sprintf("%08d|",giA);     //µo²¼§I¼úª÷ÃB
    x_h +=sTmp;


/////////////////////////////////////////////////////////////
int __fastcall XDATA::GetXDTData


//¤¤¼úµo²¼ª÷ÃB  800   Cloud ¤¤¼úµo²¼ª÷ÃB(800)   20210601 Update
        int_drop_money += _StrToInt( _StringSegment_EX(s, "|", 18) );



//µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼±i¼Æ  ª÷ÃB
    VoicePayAmt(0,gi_tot_line);
    sTmp.sprintf("%08d|",giA/200); //µo²¼§I¼ú±i¼Æ ¤¤¼úµo²¼±i¼Æ
    x_h +=sTmp;
    sTmp.sprintf("%08d|",giA);     //µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼ª÷ÃB
    x_h +=sTmp;




///////////////////////////////////////////////////////

int __fastcall XREPORT::WriteData

//¤¤¼úµo²¼ª÷ÃB  800   Cloud ¤¤¼úµo²¼ª÷ÃB(800)   20210601 Update
        int_drop_money += _StrToInt( _StringSegment_EX(s, "|", 18) );


//µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼±i¼Æ  ª÷ÃB
    VoicePayAmt(0,gi_tot_line);
    sTmp.sprintf("%08d|",giA/200); //µo²¼§I¼ú±i¼Æ ¤¤¼úµo²¼±i¼Æ
    x_h +=sTmp;
    sTmp.sprintf("%08d|",giA);     //µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼ª÷ÃB
    x_h +=sTmp;

////////////////////////////////////////////////////////////////////
//½LÂI¤H­ûÅª±b   call by _WVXZ
int __fastcall VXZDATA::WriteData


//¤¤¼úµo²¼ª÷ÃB  800   Cloud ¤¤¼úµo²¼ª÷ÃB(800)   20210601 Update
        int_drop_money += _StrToInt( _StringSegment_EX(s, "|", 18) );


//µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼±i¼Æ  ª÷ÃB
    VoicePayAmt(0,gi_tot_line);
    sTmp.sprintf("%08d|",giA/200); //µo²¼§I¼ú±i¼Æ ¤¤¼úµo²¼±i¼Æ
    x_h +=sTmp;
    sTmp.sprintf("%08d|",giA);     //µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼ª÷ÃB
    x_h +=sTmp;

///////////////////////////////////////////////////////////////////////

int __fastcall AUTOZDATA::GetZDTData(String StrZCnt, String StoreNO,  String EcrNO, String SalesNo ,
                          String Version, String PZ_date, String Z_date, String DDZ_1099, String ZDT_1050,
                          String &RtnZDTData, AnsiString &Tclsacc,
                          String &str_zrp_path, String &str_dpt_path)



//¤¤¼úµo²¼ª÷ÃB  800   Cloud ¤¤¼úµo²¼ª÷ÃB(800)   20210601 Update
        int_drop_money += _StrToInt( _StringSegment_EX(s, "|", 18) );


//µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼±i¼Æ  ª÷ÃB
    VoicePayAmt(0,gi_tot_line);
    sTmp.sprintf("%08d|",giA/200); //µo²¼§I¼ú±i¼Æ ¤¤¼úµo²¼±i¼Æ
    x_h +=sTmp;
    sTmp.sprintf("%08d|",giA);     //µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼ª÷ÃB
    x_h +=sTmp;

////////////////////////////////////////////////////////////////////////////
//¦Û°Ê¦¬»È­û¥æ¯Z
AnsiString __fastcall AUTOZDATA::AutoXData(const String StoreNO, const String EcrNO, const String SalesNo ,
                                const String SalFileName, const String Version, const AnsiString AutoZ_cnt,
                                const AnsiString AutoZ_Dt )



//¤¤¼úµo²¼ª÷ÃB  800   Cloud ¤¤¼úµo²¼ª÷ÃB(800)   20210601 Update
        int_drop_money += _StrToInt( _StringSegment_EX(s, "|", 18) );


//µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼±i¼Æ  ª÷ÃB
    VoicePayAmt(0,gi_tot_line);
    sTmp.sprintf("%08d|",giA/200); //µo²¼§I¼ú±i¼Æ ¤¤¼úµo²¼±i¼Æ
    x_h +=sTmp;
    sTmp.sprintf("%08d|",giA);     //µo²¼§I¼úª÷ÃB ¤¤¼úµo²¼ª÷ÃB
    x_h +=sTmp;

//////////////////////////////////////////////////////////////////////////////

//µo²¼§I¼úª÷ÃB  ¤¤¼úµo²¼ª÷ÃB
int __fastcall BASIC::VoicePayAmt(int StartLine, int TotalLine)

1095/1096  ¥u²Î­pª÷ÃB
171	¤¤¼úµo²¼±i¼Æ  ==> ¤¤¼úµo²¼ª÷ÃB/200
172	¤¤¼úµo²¼ª÷ÃB


























XZDATA_Mag20210423
FROM 3.20.831.2 

SaleDataVer="2021040100";  //Default:Ver     last:"2018060100"

ADD :
case 1811:
case 1811:
gtsl_easy_card->Add(tsl_x_data->Strings[i]);


int __fastcall BASIC::easy_card(int StartLine, int TotalLine)
{
  else if( StrTranType == "1811" && _StringSegment_EX(s, "|", 10).Trim()=="K3" )
               {
                 str_sale_type = _StringSegment_EX(s, "|", 13).Trim();
                 str_r_type = _StringSegment_EX(s, "|", 10).Trim();     //FG_SaleType
                 str_type =  _StringSegment_EX(s, "|", 12).Trim();      //Tran_type  310/320

                 //str_sale_type=str_r_type;
                 //int_type = _StrToInt(str_type);
                 //iTmpAmt=
                 if (str_sale_type.Pos("X") || str_sale_type.Pos("V") )
                     continue;

		 if (str_r_type.Pos("FF") || str_r_type.Pos("Z0") || str_r_type.Pos("Z1") || Trim(str_r_type)=="" )
		    {
                     if(str_type=="310" ) // ¥[­È
                       {
                          ++int_2_time;
                          int_2_money += _StrToInt(_StringSegment_EX(s, "|", 21));
                       }
                     else if(str_type=="320")     //¥[­È¨ú®ø
                       {
                          ++int_11_time;
                           int_11_money += _StrToInt(_StringSegment_EX(s, "|", 21));
                       }
                     else
                       {
                         //++int_2_time;
	                //int_2_money += _StrToInt(_StringSegment_EX(s, "|", 21));
                         ;;
                       }

	           }   // end if (str_r_type.Pos("FF") || str_r_type.Pos("Z0") || str_r_type.Pos("Z1"))
	          else if (str_r_type.Pos("R2") || str_r_type.Pos("R3"))
	           {
                     if(str_type=="310") // ¥[­È
                       {
                          --int_2_time;
                          int_2_money -= _StrToInt(_StringSegment_EX(s, "|", 21));
                       }
                     else  if(str_type=="320")     //¥[­È¨ú®ø
                       {
                          --int_11_time;
                           int_11_money -= _StrToInt(_StringSegment_EX(s, "|", 21));
                       }
                     else
                       {
                       //  --int_2_time;
	               // int_2_money -= _StrToInt(_StringSegment_EX(s, "|", 21));
                         ;;
                       }

	           }   // end else if (str_r_type.Pos("R2") || str_r_type.Pos("R3"))

               } // end of if( StrTranType == "1811")
}



XZDATA_Mag20201103
FROM 3.20.831.1 


//³¡ªù±b  2005/10/01
void __fastcall BASIC::SumAllDept(DEPT *dept)

 // 2020/11/03 Update by Lu
            sUNIT=Trim(_StringSegment_EX(s, "|", 27));
            if( sUNIT.UpperCase()=="VS" )
              continue;



XZDATA_Mag20200831

if (str_sale_type.Pos("S") && str_spc.Pos("11") )    // ÃþMM
               { ;; }
            else if (str_sale_type.Pos("S") || str_sale_type.Pos("I") || str_sale_type.Pos("C") || str_sale_type.Pos("L") )
               {
                 //¥N°â¥I,¼o±ó¤£Âk³¡ªù , L ¬~¿ï¦ý 2020/08/31
                 continue;
                }


XZDATA_Mag20200525 
// 1051¹q¤å
// ¯È¥»§@¼oµo²¼¶°­p  2019/04/23 , 2020/05/25 Update
void __fastcall BASIC::S1051MissCnt(int StartLine, int TotalLine, AnsiString &sMissRec )

//  2020/05/25 Update
            strtmp=_StringSegment_EX(s, "|", 18);   //³Æ¥Î 20 Byte
            if(  strtmp.SubString(1,1)=="1" )
            continue;
            //////////////////////


XZDATA_Mag20200409

if( Cpn75_amt )
      {
        // 2019/11/27 Update  20200409 ³U¼Æ
        //strtmp.sprintf("%s¼o¾¥¤ô§X³U¼Æ:%7ld  ",CmdStr.c_str(),Cpn75_amt);   tslCrp->Add(strtmp);
          strtmp.sprintf("%s¼o¥­ªO³U¼Æ  :%7ld  ",CmdStr.c_str(),Cpn75_amt);   tslCrp->Add(strtmp);
        }

if( Cpn76_amt )  //Update  20200409
      {
          strtmp.sprintf("%s¼o¦æ°Ê¹q·½³U¼Æ:%5ld  ",CmdStr.c_str(),Cpn76_amt);   tslCrp->Add(strtmp);
      }




//¼o¸ê·½¦^¦¬¼Æ /´£³f¨éª÷ÃB/´£³f¨é±i¼Æ
void __fastcall BASIC::Sum040RecycleDataCnt(int StartLine, int TotalLine)

case 8:   //¼o¦æ°Ê¹q·½  20200409 Lu
                               //Cpn75_cnt+=iTCnt;;
                               Cpn76_amt+=iRecyClePackCnt;
                              break;
 case 8:   //¼o¦æ°Ê¹q·½  20200409 Lu
                               //Cpn75_cnt+=iTCnt;;
                               Cpn76_amt-=iRecyClePackCnt;
                              break;

/////////////////////////

if( Cpn75_amt+i2 )
      {
         // 2019/11/27 Update  20200409 ³U¼Æ
         //strtmp.sprintf("%s¼o¾¥¤ô§X³U¼Æ:%7ld  ",CmdStr.c_str(),Cpn75_amt+i2);   tslCrp->Add(strtmp);
         strtmp.sprintf("%s¼o¥­ªO³U¼Æ  :%7ld  ",CmdStr.c_str(),Cpn75_amt+i2);   tslCrp->Add(strtmp);
        if( Update )
          {
             if( iAutoZ )
                  strtmp.sprintf("¼o¤ô|%02d|%8ld|", 0, Cpn75_amt+i2);
             else
                  strtmp.sprintf("¼o¤ô|%02d|%8ld|", 0, 0);
             AutoCrpIni->WriteString("AutoX","xInkPaks",strtmp);
          }

      }


//Update  20200409
   strtmp=AutoCrpIni->ReadString("AutoX","xPwrPaks","0");
   i1=_StrToInt(_StringSegment_EX(strtmp, "|", 2));
   i2=_StrToInt(_StringSegment_EX(strtmp, "|", 3));
   if( Cpn76_amt+i2 )
      {

        strtmp.sprintf("%s¼o¦æ°Ê¹q·½³U¼Æ:%5ld  ",CmdStr.c_str(),Cpn76_amt+i2);   tslCrp->Add(strtmp);
        if( Update )
          {
             if( iAutoZ )
                  strtmp.sprintf("¼o¦æ|%02d|%8ld|", 0, Cpn76_amt+i2);
             else
                  strtmp.sprintf("¼o¦æ|%02d|%8ld|", 0, 0);
             AutoCrpIni->WriteString("AutoX","xPwrPaks",strtmp);
          }

      }




XZDATA_Mag20200304
¥Ø«e¥u°w¹ï1040  ¸ÓÄæ¦ì=6±Æ°£¥æ¯Zµu·¸¦¬­pºâ¡A»Ý·s¼W7


int __fastcall BASIC::SumBillCPN(int StartLine, int TotalLine)
{

if (str_sale_type.Pos("Z0"))
                    {
                     
                     if( iRecycleFg == 6 || iRecycleFg == 7)   //2018/12/12   2020/3/4  ¥Ø«e¥u°w¹ï1040  ¸ÓÄæ¦ì=6±Æ°£¥æ¯Zµu·¸¦¬­pºâ¡A»Ý·s¼W7
                        giU +=iTAmt;
                     else
                        giV +=iTAmt;
                    }
                else if ( str_sale_type.Pos("R2") || str_sale_type.Pos("R3") )
                    {
                      
                      if( iRecycleFg == 6 || iRecycleFg == 7 )   //2018/12/12   2020/3/4  ¥Ø«e¥u°w¹ï1040  ¸ÓÄæ¦ì=6±Æ°£¥æ¯Zµu·¸¦¬­pºâ¡A»Ý·s¼W7
                        giU -=iTAmt;
                      else
                        giV -=iTAmt;
                    }
}



XZDATA_Mag20191225
TM_PG_·s¼WFami Point¤ä¥I±bªí

//­pºâ¥N²{ª÷ ¨ê¥d¦X­p
int __fastcall BASIC::SumTbCash(int StartLine, int TotalLine)

 // FamiPoint  2019/12/25    TM_PG_·s¼WFami Point¤ä¥I±bªí
                  iT52 = _StrToInt(_StringSegment_EX(s, "|", 52));    //³Æ¥Î
                  if (iT52)
                     {
                       ++giI;
                       giJ += iT52;
                       strtmp.sprintf("SumTbCash:¨ê¥d¦X­p:%s(iT52 FamiPoint :%d, %d)", s.c_str(), iT52 , giJ);
                       writelog(strtmp);

                     }

// FamiPoint  2019/12/25    TM_PG_·s¼WFami Point¤ä¥I±bªí
                iT52 = _StrToInt(_StringSegment_EX(s, "|", 52));    //³Æ¥Î
                if (iT52)
                     {
                       --giI;
                       giJ -= iT52;
                       strtmp.sprintf("SumTbCash:¨ê¥d¦X­p:%s(iT52 FamiPoint :%d, %d)", s.c_str(), iT52 , giJ);
                       writelog(strtmp);

                     }

////////////////////////////////////////////////////////////////////////////////////////

XZDATA_Mag20191127

if( Cpn75_amt )
      {
        // 2019/11/27 Update
        //strtmp.sprintf("%s¼o¾¥¤ô§X³U¼Æ:%7ld  ",CmdStr.c_str(),Cpn75_amt);   tslCrp->Add(strtmp);
          strtmp.sprintf("%s¼o¥­ªO¥x¼Æ  :%7ld  ",CmdStr.c_str(),Cpn75_amt);   tslCrp->Add(strtmp);
        }


// 2019/11/27 Update
         //strtmp.sprintf("%s¼o¾¥¤ô§X³U¼Æ:%7ld  ",CmdStr.c_str(),Cpn75_amt+i2);   tslCrp->Add(strtmp);
         strtmp.sprintf("%s¼o¥­ªO¥x¼Æ  :%7ld  ",CmdStr.c_str(),Cpn75_amt+i2);   tslCrp->Add(strtmp);


XZDATA_Mag20190918

V3.19.918.5
to_ptr("           ¥N°â°Ó«~ª÷ÃB³øªí     ");
// 2019/11/06 For SCO
    to_ptr("");
    to_ptr("");
    to_ptr("");



//¤¤¼úµo²¼ª÷ÃB 500
        int_drop_money += _StrToInt( _StringSegment_EX(s, "|", 19) );


//¦¬»È­û¥æ¯Z©ú²Óªí
int __fastcall BASIC::SumCasherRpt

int pay_other1_amt, pay_other2_amt;

pay_other1_amt=pay_other2_amt=0;

//¤¤¼úµo²¼ª÷ÃB  500
               pay_other1_amt +=  _StrToInt(_StringSegment_EX(s, "|", 19));

 int itotWinInvoAmt41=(iacc_invo_amt+pay_other1_amt+pay_other2_amt)-iWinnInvoAmt;    // 2017/08/15 Update ¤¤¼úµo²¼ª÷ÃB


//1041|¹q¤å
pay_other1_amt,  //¤¤¼úµo²¼ 500
pay_other2_amt,  //¤¤¼úµo²¼ 1000


////////
   strtmp=AutoCrpIni->ReadString("AutoX","invo500","0");
   i1=_StrToInt(_StringSegment_EX(strtmp, "|", 2));
   i2=_StrToInt(_StringSegment_EX(strtmp, "|", 3));

   strtmp.sprintf("%s  ¡Ï¤¤¼úµo²¼ª÷ÃB(500¤¸) :%7ld",CmdStr.c_str(),pay_other1_amt+i2);  tslCrp->Add(strtmp);

   if( Update )
     {
      if( iAutoZ )
        strtmp.sprintf("¤¤¼ú500|%02d|%8ld|", 0, pay_other1_amt+i2);
      else
        strtmp.sprintf("¤¤¼ú500|%02d|%8ld|", 0, 0);
      AutoCrpIni->WriteString("AutoX","invo500",strtmp);
    }

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



XZDATA_Mag20190213

/////////////////////////// 2014/12/10 //////////////////////////////////////////////////////////////
   strtmp=AutoCrpIni->ReadString("AutoX","s1051cnt","0");
   i1=_StrToInt(_StringSegment_EX(strtmp, "|", 2));
   i2=_StrToInt(_StringSegment_EX(strtmp, "|", 3));

   AnsiString sMissRec, AutoXsMissRec, PrintAutoXsMissRec;
   AutoXsMissRec=AutoCrpIni->ReadString("AutoX","s1051cntMissRec","");

   S1051MissCnt(0,gi_1051_line,sMissRec);
   int  sMissRecCnt=giC;
   AutoXsMissRec+=sMissRec;
   PrintAutoXsMissRec=AutoXsMissRec;

   sLog.sprintf("SumCasherRpt ¦¬»È­û¥æ±µ¯Z©ú²Óªí: AutoCrp.ini:: AutoX -> s1051cnt = %s ,¯È¥»§@¼oµo²¼±i¼Æ  :%8ld, AutoXsMissRec(%s)",
                                                  strtmp, giA+i2,AutoXsMissRec.c_str());
   writelog(sLog);

   strtmp.sprintf("%s¯È¥»§@¼oµo²¼:%7ld ¢x         ¢x",CmdStr.c_str(), giA+i2 );   tslCrp->Add(strtmp);   //¢|¢w¢w¢w¢w¢w¢}


     if( Update )
     {
      if( iAutoZ )
       {
        strtmp.sprintf("¯È¼o|%02d|%8ld|", 0, giA+i2);
        }
      else
       {
         strtmp.sprintf("¯È¼o|%02d|%8ld|", 0, 0);
         AutoXsMissRec="";
       }

      AutoCrpIni->WriteString("AutoX","s1051cnt",strtmp);
      AutoCrpIni->WriteString("AutoX","s1051cntMissRec",AutoXsMissRec);
     }
///////////////////////////////////////////////////////////////////////////////////////////////////////
 /***
   strtmp.sprintf("                             ¦¬»È­ûÃ±³¹");  tslCrp->Add(strtmp);
   strtmp.sprintf("                            ¢z¢w¢w¢w¢w-¢{");   tslCrp->Add(strtmp);
   strtmp.sprintf("                            ¢x         ¢x");   tslCrp->Add(strtmp);
   strtmp.sprintf("                            ¢x         ¢x");   tslCrp->Add(strtmp);
   strtmp.sprintf("                            ¢x         ¢x");   tslCrp->Add(strtmp);
   strtmp.sprintf("                            ¢|¢w¢w¢w¢w-¢}");   tslCrp->Add(strtmp);
   ****/

   if( PrintAutoXsMissRec.Trim() != "")
     {
     //¯È¥»§@¼oµo ©ú²Ó  2019/04/26
     strtmp.sprintf("--------¯È¥»§@¼oµo²¼©ú²Ó----------");  tslCrp->Add(strtmp);
     strtmp.sprintf("§Ç      ¥æ©ö§Ç¸¹     µo²¼¸¹½X");  tslCrp->Add(strtmp);
     i2=0;
     while(1)
     {
     i2++;
     tmpSer=_StringSegment_EX(PrintAutoXsMissRec, "|", i2);
     if(tmpSer.Trim()=="" || i2>500 ) break;
     strtmp.sprintf("%d.%s",i2, tmpSer );  tslCrp->Add(strtmp);

     }  // end of while

     strtmp.sprintf("(§@¼oµo²¼¦@©ú²Ó¤£¥]§t¥d¯È­«¦L");  tslCrp->Add(strtmp);
   }
   strtmp.sprintf("\n\n\n\n");  tslCrp->Add(strtmp);
   strtmp.sprintf("\x1b\x69");  tslCrp->Add(strtmp); //¤Á¯È

    //¿é¥XÀÉ®×
   if (FileExists(SCasherRpt.c_str() ))
        DeleteFile(SCasherRpt.c_str());
///////////////////////////////////////////////////////////////////////////////////////////////////////


// 1051¹q¤å
// ¯È¥»§@¼oµo²¼¶°­p  2019/04/23 Update
void __fastcall BASIC::S1051MissCnt(int StartLine, int TotalLine, AnsiString &sMissRec )
{
     giA = giB = giC = giD = 0;

     AnsiString str_miss_type, tmpSer, strtmp, tmpVsNo, s ;
     int iTmpB,iTmpC,iTmpD;

     sMissRec="";
     if (gbl_1051_haveline)
     {
        for(int i=0; i<gtsl_1051_sal->Count; i++)
        {
            iTmpB = iTmpC = 0;
            s=gtsl_1051_sal->Strings[i];
            str_miss_type = _StringSegment_EX(s, "|",8);  //µ²±b«¬ºA(V1,Z0,R2,R3...)

            tmpSer=_StringSegment_EX(s, "|",11);     //§@¼o¥æ©ö§Ç¸¹ 10 Byte

            strtmp=_StringSegment_EX(s, "|", 12);   //§@¼oµo²¼¸¹½X°_ 10 Byte
            tmpVsNo=strtmp;  //.SubString(3,8);

            if( Trim(tmpVsNo)=="" || tmpVsNo.SubString(3,8)=="00000000" )
              {
               //strtmp.sprintf("¤£¶}µo²¼§@¼o¥æ©ö:(%s)..",tmpVsNo );
               //writelog(strtmp);
               continue;
              }


            if( str_miss_type.Pos("R") )
            {
                //if( Trim(tmpVsNo)!="" && tmpVsNo!="00000000" )
                //{
                        strtmp=_StringSegment_EX(s, "|",15);
                        iTmpB=_StrToInt(strtmp.Trim() );     //¨Ï¥Î¸ü¨ã°Ï¤À  '0'¥¼¨Ï¥Î¸ü¨ã '1'¨Ï¥Î¸ü¨ã
                        
                        if( iTmpB ==0)
                        {
                         giA++;
                         if( str_miss_type.Pos("R2") || str_miss_type.Pos("R3") )
                         {
                            giC++;
                            strtmp.sprintf("%10s   %-2s-%-8s|",tmpSer.SubString(3,8) ,tmpVsNo.SubString(1,2),tmpVsNo.SubString(3,8)  );
                            sMissRec += strtmp;
                         }
                        }
                        else
                        {
                         giB++;
                        }
                //}
            }


        }    // end for

        strtmp.sprintf("S1051MissCnt:(R)¯È¥»§@¼oµo²¼±i¼Æ(%d),(R2,R3)(%d), ¸ü¨ã§@¼oµo²¼±i¼Æ(%d), (%s)",giA,giC,giB,sMissRec.c_str() );
        writelog(strtmp);
    }
 }







/**  2019/03/27 Update
                        if (sDONGLE_TYPE.Pos("FP") || sDONGLE_TYPE.Pos("MFP") || sDONGLE_TYPE.Pos("EC") )
                             giV += _StrToInt(_StringSegment_EX(s, "|", 29));   //ÃþMM_MFP
                        else
                             giX += _StrToInt(_StringSegment_EX(s, "|", 29));   //ÃþMM_TM
                        **/
                        if (sDONGLE_TYPE.Pos("TM")
                             giX += _StrToInt(_StringSegment_EX(s, "|", 29));   //ÃþMM_TM
                        else
                             giV += _StrToInt(_StringSegment_EX(s, "|", 29));   //ÃþMM_MFP





//¥»¤é¨Ó«È¼Æ
int __fastcall BASIC::SumQt_tcust(int StartLine,int TotalLine)

//invo_amt+kcolx_amt+kcolf_amt  (32:µo²¼ª÷ÃB, 37:§é¦©\Åýª÷ÃB, 44:¤£¶}µo²¼ª÷ÃB(À³), 45:¤£¶}µo²¼ª÷ÃB(§K)
            //µo²¼ª÷ÃB  2019/02/13     °l¥[ 37:§é¦©\Åýª÷ÃB
            i_invo_cnt = _StrToInt(_StringSegment_EX(s, "|", 32))+
                         _StrToInt(_StringSegment_EX(s, "|", 37))+
                         _StrToInt(_StringSegment_EX(s, "|", 44))+
                         _StrToInt(_StringSegment_EX(s, "|", 45))-iCOInvoAmtTxt-iCOInvoAmtNxt;
                         //_StrToInt(gtsl_tot->Strings[i].SubString(345,8))+
                         //_StrToInt(gtsl_tot->Strings[i].SubString(354,8));


///////////////////////////////////////////////////
XZDATA_Mag20181207
 
void __fastcall BASIC::Sum040RecycleDataCnt(int StartLine, int TotalLine)
{

    giE = 0;    //´£³f¨éª÷ÃB
    giF = 0;    //´£³f¨é±i¼Æ
    // 2018/12/07 Lu Update
    int iPaCpnAmt = 0;         //¯È¥»§é»ù¨éª÷ÃB
    int iPaCpnCnt = 0;         //¯È¥»§é»ù¨é±i¼Æ
    int iPaPresentAmt = 0;    //¯È¥»Â§¨é±i¼Æ
    int iPaPresentCnt = 0;    //¯È¥»Â§¨éª÷ÃB

    giM=iPaCpnAmt;         //¯È¥»§é»ù¨éª÷ÃB
    giN=iPaCpnCnt;         //¯È¥»§é»ù¨é±i¼Æ
    giO=iPaPresentAmt;         //¯È¥»§é»ù¨éª÷ÃB
    giP=iPaPresentCnt;         //¯È¥»§é»ù¨é±i¼Æ

                 if( sPayType  == "E0" ) //´£³f¨é
                   {
                      giE += iTAmt;    //´£³f¨éª÷ÃB
                      giF ++;          //´£³f¨é±i¼Æ
                   }

                 // 2018/12/07 Lu Update   , 2019/01/14 Update
                 // if( ( sPayType  == "C0" || sPayType  == "C9" ) && iRecycleFg != 6  ) //  ¯È¥»§é»ù¨é
                 if( ( sPayType  == "C0" || sPayType  == "C9" ) && iRecycleFg == 0  ) //  ¯È¥»§é»ù¨é
                   {
                      iPaCpnAmt += iTAmt;    //¯È¥»§é»ù¨éª÷ÃB
                      iPaCpnCnt ++;          //¯È¥»§é»ù¨é±i¼Æ
                   }

                  // 2018/12/07 Lu Update
                 if( ( sPayType  == "B1" || sPayType  == "B2" ) ) //  ¯È¥»Â§¨é
                   {
                      iPaPresentAmt += iTAmt;    //¯È¥»Â§¨éª÷ÃB
                      iPaPresentCnt ++;          //¯È¥»Â§¨é±i¼Æ
                   }


           ................

                if( sPayType  == "E0" ) //´£³f¨é
                   {
                      giE -= iTAmt;    //´£³f¨éª÷ÃB
                      giF --;          //´£³f¨é±i¼Æ
                   }

                   // 2018/12/07 Lu Update   , 2019/01/14 Update
                 // if( ( sPayType  == "C0" || sPayType  == "C9" ) && iRecycleFg != 6  ) //  ¯È¥»§é»ù¨é
                 if( ( sPayType  == "C0" || sPayType  == "C9" ) && iRecycleFg == 0  ) //  ¯È¥»§é»ù¨é
                   {
                      iPaCpnAmt -= iTAmt;    //¯È¥»§é»ù¨éª÷ÃB
                      iPaCpnCnt --;          //¯È¥»§é»ù¨é±i¼Æ
                   }

                  // 2018/12/07 Lu Update
                 if( ( sPayType  == "B1" || sPayType  == "B2" ) ) //  ¯È¥»Â§¨é
                   {
                      iPaPresentAmt -= iTAmt;    //¯È¥»Â§¨éª÷ÃB
                      iPaPresentCnt --;          //¯È¥»Â§¨é±i¼Æ
                   }


    giM=iPaCpnAmt;         //¯È¥»§é»ù¨éª÷ÃB
    giN=iPaCpnCnt;         //¯È¥»§é»ù¨é±i¼Æ
    giO=iPaPresentAmt;         //¯È¥»§é»ù¨éª÷ÃB
    giP=iPaPresentCnt;         //¯È¥»§é»ù¨é±i¼Æ

}



int __fastcall BASIC::SumCasherRpt
int __fastcall BASIC::SumCasherRptXDT

    iacc_amt14=giE; //´£³f¨éª÷ÃB
    iacc_cnt14=giF; //´£³f¨é±i¼Æ

    // 2018/12/07 Lu Update
    int iPaCpnAmt = giM;         //¯È¥»§é»ù¨éª÷ÃB
    int iPaCpnCnt = giN;         //¯È¥»§é»ù¨é±i¼Æ
    int iPaPresentAmt = giO;    //¯È¥»Â§¨éª÷ÃB
    int iPaPresentCnt = giP;    //¯È¥»Â§¨é±i¼Æ

   ...............
   if( Update )
     {
      if( iAutoZ )
       strtmp.sprintf("¯È¼o|%02d|%8ld|", 0, giA+i2);
      else
       strtmp.sprintf("¯È¼o|%02d|%8ld|", 0, 0);

      AutoCrpIni->WriteString("AutoX","s1051cnt",strtmp);
     }
   ///////////////////////////////////////////////////////////////////////////
   // 2018/12/07 Lu Update
    //iPaCpnAmt ¯È¥»§é»ù¨éª÷ÃB
    //iPaCpnCnt ¯È¥»§é»ù¨é±i¼Æ
    //iPaPresentAmt ¯È¥»Â§¨éª÷ÃB
    //iPaPresentCnt ¯È¥»Â§¨é±i¼Æ

    strtmp=AutoCrpIni->ReadString("AutoX","iPaPresentCnt","0");  //¯È¥»§éÂ§¨é±i¼Æ
    i1=_StrToInt(_StringSegment_EX(strtmp, "|", 2));
    i2=_StrToInt(_StringSegment_EX(strtmp, "|", 3));

    sLog.sprintf("SumCasherRpt ¦¬»È­û¥æ±µ¯Z©ú²Óªí: AutoCrp.ini:: AutoX -> iPaPresentCnt = %s ,¯È¥»Â§¨é±i¼Æ  :%8ld", strtmp,
                                                     iPaPresentCnt+i2);
    writelog(sLog);

    strtmp.sprintf("%s¯È¥»Â§¨é±i¼Æ:%7ld ¢x         ¢x",CmdStr.c_str(), iPaPresentCnt+i2 );   tslCrp->Add(strtmp);   //¢|¢w¢w¢w¢w¢w¢}


     if( Update )
     {
      if( iAutoZ )
       strtmp.sprintf("¯ÈÂ§|%02d|%8ld|", 0, iPaPresentCnt+i2);
      else
       strtmp.sprintf("¯ÈÂ§|%02d|%8ld|", 0, 0);

      AutoCrpIni->WriteString("AutoX","iPaPresentCnt",strtmp);
     }

    /////////////////////////////////////////////////

    strtmp=AutoCrpIni->ReadString("AutoX","iPaCpnCnt","0");  //¯È¥»§é»ù¨é±i¼Æ
    i1=_StrToInt(_StringSegment_EX(strtmp, "|", 2));
    i2=_StrToInt(_StringSegment_EX(strtmp, "|", 3));

    sLog.sprintf("SumCasherRpt ¦¬»È­û¥æ±µ¯Z©ú²Óªí: AutoCrp.ini:: AutoX -> iPaCpnCnt = %s ,¯È¥»§é»ù¨é±i¼Æ  :%8ld", strtmp,
                                                     iPaCpnCnt+i2);
    writelog(sLog);

    strtmp.sprintf("%s¯È¥»§é»ù¨é±i¼Æ:%5ld ¢x         ¢x",CmdStr.c_str(), iPaCpnCnt+i2 );   tslCrp->Add(strtmp);   //¢|¢w¢w¢w¢w¢w¢}


     if( Update )
     {
      if( iAutoZ )
       strtmp.sprintf("¯È§é|%02d|%8ld|", 0, iPaCpnCnt+i2);
      else
       strtmp.sprintf("¯È§é|%02d|%8ld|", 0, 0);

      AutoCrpIni->WriteString("AutoX","iPaCpnCnt",strtmp);
     }


///////////////////////////////////////////////////////////////////////////////////////////////////////

//­pºâ2017/03/08 CPN
int __fastcall BASIC::SumBillCPN(int StartLine, int TotalLine)
{
int iRecycleFg;

iRecycleFg=_StrToInt(_StringSegment_EX(s, "|", 29), "¼o¸ê·½¦^fg_29");  //¦^¦¬µù°O

if( sPAY_TYPE.SubString(1,1)=="C" )
            {
                stmp.sprintf("SumBillCPN:1040->%s",gtsl_bil->Strings[i] );
                writelog(stmp);
                if (str_sale_type.Pos("Z0"))
                    {
                     //if( iPayID == 109 || iPayID == 001 || iPayID == 003 || (iPayID >= 901 && iPayID <= 999 ) )     //«D¹êÅé¨éª÷ÃB   2017/06/26 °l¥[ 001, 003 2019/12/07 (iPayID >= 901 && iPayID <= 999 )
                     if( iRecycleFg == 6)   //2018/12/12
                        giU +=iTAmt;
                     else
                        giV +=iTAmt;
                    }
                else if ( str_sale_type.Pos("R2") || str_sale_type.Pos("R3") )
                    {
                      //if( iPayID == 109 || iPayID == 001 || iPayID == 003 || (iPayID >= 901 && iPayID <= 999 ) )    //«D¹êÅé¨éª÷ÃB   2017/06/26 °l¥[ 001, 003 2019/12/07 (iPayID >= 901 && iPayID <= 999 )
                      if( iRecycleFg == 6)   //2018/12/12
                        giU -=iTAmt;
                      else
                        giV -=iTAmt;
                    }
            }   // end of if( sPAY_TYPE.SubString(0,1)=="C" )


}

/////////////////////


XZDATA_Mag20180820   
0029798: (ºñ®q´Â¤é©±)ºû­×³qª¾¨ç---180619-0122...FM-014788-SC ©±ªø§iª¾Àç¦¬±b°È¦³°ÝÃD 
¥H¦¬»È¾÷¥æ±µ¯Zªí¬d¬Ý6/17¤Î6/18 ©ó6/18¦³±bªí¤W¦³¨â±øµù°O¬°¦¸¤éÀç¦¬ 
¦ý6/17¤W«h¥uÅã¥Ü¤@±ø±b ©±ªø¸ß°Ý¤°»ò­ì¦]³y¦¨
 

  else if( Trim(sIdx)=="10" )  //10:³Ì«á¤@µ§
       {
              // 2018/08/20 make By Lu
              // x->dt_begin = _StringSegment_EX(ZNT_1099, "|", 5).SubString(1,8);
              // x->tm_begin = "000001";
               x->dt_begin=sSalesLoginDttm.SubString(1,8);
               x->tm_begin=sSalesLoginDttm.SubString(9,6);       

               x->dt_end =  _StringSegment_EX(ZNT_1099, "|", 5).SubString(1,8);  // x->dt_begin;  2018/08/20 make By Lu
               x->tm_end = ed_date_time.SubString(9,6);
               AutoXFg="1";  //0:·í§@¬O¦Û°Ê¤éµ²¤§¥æ¯Z

       }



else
       {
         // 2018/08/20 make By Lu
         //x->dt_begin = _StringSegment_EX(ZNT_1099, "|", 5).SubString(1,8);     //«e¦¸µ²±b¤é´Á
         //x->tm_begin = "000001";                                               //«e¦¸µ²±b®É¶¡
         x->dt_begin=sSalesLoginDttm.SubString(1,8);
         x->tm_begin=sSalesLoginDttm.SubString(9,6);

         x->dt_end = _StringSegment_EX(ZNT_1099, "|", 5).SubString(1,8);  // x->dt_begin;  2018/08/20 make By Lu
         x->tm_end = "235959";
         AutoXFg="0";  //0:·í§@¬O¦Û°Ê¤éµ²¤§¥æ¯Z
       }




//////////////////////////////////////////////////

XZDATA_Mag20180613   ³¡ªù«P¾P§é¦©ª÷ÃB/¦¬»È­û¥æ±µ¯Z©ú²Óªí:


SumCasherRptXDT ¦¬»È­û¥æ±µ¯Z©ú²Óªí:

AnsiString nXDTdttb = _StringSegment_EX(sStr1095, "|", 10) + _StringSegment_EX(sStr1095, "|", 11);  //«e¦¸¥æ¯Z®É¶¡
AnsiString nXDTdttn = _StringSegment_EX(sStr1095, "|", 12) + _StringSegment_EX(sStr1095, "|", 13);  //¥»¦¸¥æ¯Z®É¶¡

AnsiString bt,BefTime,nt,NowTime, sStoreNo, sStoreName,sLog;


bt=  nXDTdttb;
   BefTime=bt.SubString(1,4)+"-"+bt.SubString(5,2)+"-"+bt.SubString(7,2)+"  "+bt.SubString(9,2)+":"+bt.SubString(11,2);
   nt=  nXDTdttn;  //_StringSegment_EX(sTranCnt, "|", 5); // sTranCnt.SubString(21,14);  1041
   NowTime=nt.SubString(1,4)+"-"+nt.SubString(5,2)+"-"+nt.SubString(7,2)+"  "+nt.SubString(9,2)+":"+nt.SubString(11,2);


strtmp.sprintf("%s        ¦¬»È­û¥æ±µ¯Z©ú²Óªí",CmdStr.c_str()); tslCrp->Add(strtmp);
   // Vita 29175:TM_¦¬»È­û¥æ±µ¯Zªí·s¼W¦C¥Ü¸Ó¯Z¶}©l®É¶¡
   strtmp.sprintf("%s%s ¶}©l",CmdStr.c_str(), BefTime);   tslCrp->Add(strtmp);
   strtmp.sprintf("%s%s µ²§ô  ¾÷¸¹:%s",CmdStr.c_str(), NowTime,_StringSegment_EX(sTranCnt, "|", 4) );   tslCrp->Add(strtmp);
   //strtmp.sprintf("%s%s     ¾÷¸¹:%s",CmdStr.c_str(),NowTime,_StringSegment_EX(sTranCnt, "|", 4) );   tslCrp->Add(strtmp);
   strtmp.sprintf("%s©±¸¹:%s    ©±¦W:%s",CmdStr.c_str(),_StringSegment_EX(sTranCnt, "|", 3), sStoreName);  tslCrp->Add(strtmp);
   strtmp.sprintf("%s¦¬»È­û½s¸¹:%s",CmdStr.c_str(),_StringSegment_EX(sTranCnt, "|", 8) );   tslCrp->Add(strtmp);
   strtmp.sprintf("%s§ë®w©ú²Ó:",CmdStr.c_str());   tslCrp->Add(strtmp);



////////////
if( Trim(SaleDataVer)=="")
        SaleDataVer="2018060100";  //Default:Ver     last:"2017120100"







ULog.h
//³¡ªù§O¶°­pTABLE
typedef struct
    {
        int am_dpsitm;              // ³¡ªù¥æ©ö¶µ¼Æ
        int am_dpsale;              // ³¡ªù¾P°âª÷ÃB
        int am_dpmitm;              // ³¡ªù»~°h¶µ¼Æ
        int am_dpmiss;              // ³¡ªù»~°hª÷ÃB

        int am_mmDis;               // ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13
        int am_mmDismiss;           // ³¡ªù«P¾P§é¦©»~°hª÷ÃB    Lu 2018/06/13
    }DEPT;



/ULog.cpp
//³¡ªù±b  2005/10/01
void __fastcall BASIC::SumAllDept(DEPT *dept)
{



 if (gbl_rec_haveline)
    {

 
   for (int i=0; i<20; i++)
        {
          dept[i].am_mmDis = 0;         // ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13
          dept[i].am_mmDismiss = 0;     // ³¡ªù«P¾P§é¦©»~°hª÷ÃB    Lu 2018/06/13
        }
 

/**********************   ¹w°â¯S§O³B²z  **********************/
            iDisSubAmt_SPC =  iDisSubAmt;     //iDisSubAmt_SPC ±M¥Î³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13

            if (str_sale_type.Pos("S") && str_spc.Pos("11") )    // ÃþMM
                {
                  iItemQty=0;
                  iDisSubAmt=0;
                  iSubSubAmt=0;
                  iItemAmt=iItemAmt*(-1);
                }

            if ( str_sale_type.Pos("A") && str_spc.Pos("10") )     //¹w°â§I´«°Ó«~ ¤£¦©°£§éÅý³æ
               {
                 //    iSubSubAmt=0;                               // 2017/07/10 ­n¦©°£§éÅý³æ ,©Ò¥H Mark
                 iDisSubAmt=0;                                     // 2017/09/21 ¦]¤w¦©°£ ÃþMM, ©Ò¥HµL¶·¦A¦©  MM §é¦© ÅuÃD , ¦]ÃþMM=MM §é¦©
                 iSubSubAmt_SPC=0;                                  //­n¦©°£§éÅý³æ   Lu 2018/06/13
               }
           /*************************************************************/




   if (str_r_type.Pos("FF") || str_r_type.Pos("Z0") || str_r_type.Pos("Z1") || Trim(str_r_type)=="" )
            {
                if (str_sale_type.Pos("0"))             //¥¿¦V
                {
                    dept[iDept].am_dpsitm += iItemQty;
                    dept[iDept].am_dpsale += iNetItemAmt;

                    dept[iDept].am_mmDis += (iDisSubAmt_SPC+iSubSubAmt_SPC);    // ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13
                }
                else if (str_sale_type.Pos("1"))        //­t¦V
                {
                    dept[iDept].am_dpsitm -= iItemQty;
                    dept[iDept].am_dpsale -= iNetItemAmt;

                    dept[iDept].am_mmDis -= (iDisSubAmt_SPC+iSubSubAmt_SPC);    // ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13
                }
            }
            else if (str_r_type == "R2" || str_r_type == "R3" )
            {

                //³¡ªù»~°h¶µ¼Æ¡Bª÷ÃB
                if ( str_sale_type.Pos("0") )             //¥¿¦V
                {
                    dept[iDept].am_dpmitm += iItemQty;
                    dept[iDept].am_dpmiss += iNetItemAmt;

                    dept[iDept].am_mmDismiss += (iDisSubAmt_SPC+iSubSubAmt_SPC);    // ³¡ªù«P¾P§é¦©»~°hª÷ÃB        Lu 2018/06/13
                }
                else if ( str_sale_type.Pos("1") )        //­t¦V
                {
                    dept[iDept].am_dpmitm -= iItemQty;
                    dept[iDept].am_dpmiss -= iNetItemAmt;

                    dept[iDept].am_mmDismiss -= (iDisSubAmt_SPC+iSubSubAmt_SPC);    // ³¡ªù«P¾P§é¦©»~°hª÷ÃB        Lu 2018/06/13
                }

            }



}



UXZdataClass.cpp
//½LÂI¤H­ûÅª±b   call by _WVXZ
int __fastcall VXZDATA::WriteData(const String StoreNO, const String EcrNO, const String SalesNo ,
                                const String SalFileName, const String Version)
{

       AnsiString z_f, z_a1093, z_ammdis;


        // ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13
        z_a1093.sprintf("1093|%04d|%-6s|%-2s|%14s|%5s|%-10s|", 275,
                                      gchar_tencode,
                                      z->no_tm.c_str(),           //¦¬»È¾÷¾÷¸¹
                                      str_date_time.c_str(),      //²{¦b®É¶¡
                                      z->bg_noclose.c_str(),      //¤éµ²§Ç¸¹
                                      sYYMMDDZZ.c_str()          //Z±bªí§Ç¸¹
                                      );
        z_ammdis="";

        for (int i=0; i<20; i++)
        {
            z->tb_depcal[i].am_dpsitm.sprintf("%08d", dept[i].am_dpsitm);
            z_f += (z->tb_depcal[i].am_dpsitm+"|");
            s1 += dept[i].am_dpsitm;

            z->tb_depcal[i].am_dpsale.sprintf("%08d", dept[i].am_dpsale);
            z_f += (z->tb_depcal[i].am_dpsale+"|");
            s2 += dept[i].am_dpsale;

            z->tb_depcal[i].am_dpmitm.sprintf("%08d", dept[i].am_dpmitm);
            z_f += (z->tb_depcal[i].am_dpmitm+"|");
            s3 += dept[i].am_dpmitm;

            z->tb_depcal[i].am_dpmiss.sprintf("%08d", dept[i].am_dpmiss);
            z_f += (z->tb_depcal[i].am_dpmiss+"|");
            s4 += dept[i].am_dpmiss;

            // ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13
            sTmp.sprintf("%08d", dept[i].am_mmDis - dept[i].am_mmDismiss);
            z_a1093 += (sTmp+"|");

            sTmp.sprintf("%08d|%08d", dept[i].am_mmDis , dept[i].am_mmDismiss);
            z_ammdis += (sTmp+"|");

        }

        // ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13
        sTmp.sprintf("%40s|\n", " ");
        z_a1093 += (sTmp);
        z_ammdis += (sTmp);




    String str_sal;
    //str_sal = str_01 + "\n"+ str_zrp + str_98 + str_99;
    str_sal = str_01 + "\n"+ str_98+str_zrp + z_a1093 + str_99;    // z_a1093 ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13

   //³¡ªù±bªí   
    AnsiString str_dpt_path;
    strcpy(report->char_filename, ChangeFileExt(str_z_filename,".vpt").c_str() );

    if( _StrToInt(str_cs_entry)==1)
         report->CreateReport('E', str_zrp, StrBillPay, gchar_tencode, gchar_ecr_no,0,0,0,0,tsl_subsale,0, z_ammdis);
    else
         report->CreateReport('e', str_zrp, StrBillPay, gchar_tencode, gchar_ecr_no,0,0,0,0,tsl_subsale,0, z_ammdis);



}




UReport.h
int __fastcall Dept(AnsiString &ZData, char *ptr_tencode, char *ptr_ecr_no, int XR=0,
                        TStringList *tsl=NULL, AnsiString s1093=NULL);   //³¡ªù±bªí

int CreateReport(char rpt_type, AnsiString sSal, AnsiString sPayStr,
                     char *ptr_tencode, char *ptr_ecr_no,
                     int iqt5_15217totrev=0, int iam5_15217totrev=0,
                     int iqt5_18219totrev=0, int iam5_18219totrev=0,
                     TStringList *tsl = NULL, int AutoZflg=0, AnsiString s1093=NULL);


/////////////////////////
UReport.cpp

int __fastcall Dept(AnsiString &ZData, char *ptr_tencode, char *ptr_ecr_no, int XR=0,
                        TStringList *tsl=NULL, AnsiString s1093)   //³¡ªù±bªí

    //³¡ªù¦X­p¥[Á`
    //to_ptr("³¡ªù¦X­p");
    //to_ptr(qtyamt);
    //to_ptr(ramt);

    /////////////////////////////////  ³¡ªù«P¾P³øªí  ////////////////////////////////////
    int int_a_Tot,  int_b_Tot;
    if( s1093 != NULL &&  s1093.Trim() != "")
      {
       int_a = 0; int_b = 0; int_a_Tot=0;  int_b_Tot =0;

       to_ptr("");

       if( XR==21 || XR==22)
       StrLine.sprintf("%s§Ç¸¹:%s©±¸¹:%s ¾÷:%s",gchar_date_format,str_bg_noclose,
                                           str_tencode,str_ecr_no);
       else
       StrLine.sprintf("%s§Ç¸¹:%s©±¸¹:%s ¾÷:%s",gchar_date_format,str_nz_cnt,
                                           str_tencode,str_ecr_no);

       if (XR==21) //21:Ã±¨ì 22:Ã±°h
            to_ptr("        ³¡ªù«P¾P³øªí(Ã±¨ì)     ");
       else if (XR==22) //21:Ã±¨ì 22:Ã±°h
            to_ptr("        ³¡ªù«P¾P³øªí(Ã±°h)     ");
       else
            to_ptr("           ³¡ªù«P¾P³øªí     ");

       to_ptr("");

       StrLine.sprintf("³¡ªù   ¾P°â«P¾Pª÷ÃB   °h³f«P¾Pª÷ÃB");
       to_ptr(StrLine);
       for (int i=1; i<21; i++)
         {
             int_a = _StrToInt(_StringSegment_EX(s1093, "|", (2*i)-1 ) );
             int_a_Tot += int_a  ;  // total
             int_b = _StrToInt(_StringSegment_EX(s1093, "|", (2*i) ) );
             int_b_Tot += int_b  ;  // total

             qtyamt.sprintf("%8d", int_a);
             ramt.sprintf("%8d", int_b);
             sCount.sprintf("%02d", (i));

             StrLine.sprintf("%3s   %s      %s",sCount, qtyamt, ramt);
             to_ptr(StrLine);
             int_a = 0;
             int_b = 0;
         }

      ramt.sprintf("%8d      %8d",  int_a_Tot, int_b_Tot );

      StrLine.sprintf("--------------------------------------");
      to_ptr(StrLine);

      StrLine.sprintf("¦X­p  %s   ", ramt);
      to_ptr(StrLine);

      //to_ptr("\n\n\n\n");
      to_ptr("");
      to_ptr("");
      to_ptr("");
      to_ptr("");
      StrLine.sprintf("\x1b\x69");
      to_ptr(StrLine);
    }


    ///////////////////////¥N°â°Ó«~ª÷ÃB³øªí//////////////////////////////////





/////////////////////////////

// ³¡ªù«P¾P§é¦©ª÷ÃB        Lu 2018/06/13
int REPORT::CreateReport(char rpt_type, AnsiString sSal, AnsiString sPayStr,
                     char *ptr_tencode, char *ptr_ecr_no,
                     int iqt5_15217totrev, int iam5_15217totrev,
                     int iqt5_18219totrev, int iam5_18219totrev,
                     TStringList *tsl, int AutoZflg, AnsiString s1093 )

 case 'E':                                 //½LÂI¤H­û³¡ªù   21:Ã±¨ì 22:Ã±°h
          Dept(sSal, ptr_tencode, ptr_ecr_no,21, tsl, s1093);
          break;
      case 'e':                                 //½LÂI¤H­û³¡ªù   21:Ã±¨ì 22:Ã±°h
          Dept(sSal, ptr_tencode, ptr_ecr_no,22, tsl, s1093);








///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
XZDATA_Mag20180101
if( Trim(SaleDataVer)=="")
        SaleDataVer="2017120100";  //Default     last:"2017080100"



XZDATA_Mag20171225

2017/12/26 ¹A·|°Ó«~¦P¦C C0/C1   ¶}µo²¼¤£¦CÀç¦¬  1013.VDC_NO=17
     // ¥~¥[¤âÄò¶O,§Y®ÉÁÊ¥N°âÂI¥d¶°­p
    void __fastcall BASIC::Sub_C0InvoAmt(int StartLine, int TotalLine);
	       i_trans_flag = _StrToInt(str_trans_flag);       //SPC_FLG  ¥æ©öÃþ§O

            ////////////////////   ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X   /////////////////////
            if (str_good_no.SubString(1, 1) == "M")  //¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X
            {
                  if (str_type.Pos("A0"))
                  {
                      str_type = "C0";
                      i_trans_flag = 2;    //SPC_FLG  ¥æ©öÃþ§O
                  }
                  else if (str_type.Pos("A1"))
                  {
                      str_type = "C1";
                      i_trans_flag = 2;    //SPC_FLG  ¥æ©öÃþ§O
                  }
            }
            //////////////////// END  ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X  ///////////////////

			****************************************************************************************************************************************************

    // ÂI¥d¤âÄò¶OÀ³§Kµ|
    void __fastcall BASIC::Sub_C0C1TaxInvoAmt(int StartLine, int TotalLine);
	    ////////////////////   ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X   /////////////////////
            if (str_good_no.SubString(1, 1) == "M")  //¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X
            {
                  if (str_type.Pos("A0"))
                  {
                      str_type = "C0";
                      i_trans_flag = 2;    //SPC_FLG  ¥æ©öÃþ§O
                  }
                  else if (str_type.Pos("A1"))
                  {
                      str_type = "C1";
                      i_trans_flag = 2;    //SPC_FLG  ¥æ©öÃþ§O
                  }
            }
            //////////////////// END  ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X  ///////////////////

          ****************************************************************************************************************************************************



    // ÂI¥d¤âÄò¶O¼Æ¶q
    void __fastcall BASIC::Sub_C0C1TaxInvoQty(int StartLine, int TotalLine);
	    ////////////////////   ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X   /////////////////////
            if (str_good_no.SubString(1, 1) == "M")  //¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X
            {
                  if (str_type.Pos("A0"))
                  {
                      str_type = "C0";
                      i_trans_flag = 2;    //SPC_FLG  ¥æ©öÃþ§O
                  }
                  else if (str_type.Pos("A1"))
                  {
                      str_type = "C1";
                      i_trans_flag = 2;    //SPC_FLG  ¥æ©öÃþ§O
                  }
            }
            //////////////////// END  ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X  ///////////////////

          ****************************************************************************************************************************************************


    // ¥~¥[¤âÄò¶O,§Y®ÉÁÊ¥N°âÂI¥d¶°­p ¥H³s½u°Ï¤À¤ÀÃþ
    void __fastcall BASIC::Sub_C0InvoAmt4VDC(int StartLine, int TotalLine);
	    /****************   ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X   /////////////////////
            if (str_good_no.SubString(1, 1) == "M")  //¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X
            {
                  if (str_type.Pos("A0"))
                  {
                      str_type = "C0";
                      i_trans_flag = 2;    //SPC_FLG  ¥æ©öÃþ§O
                  }
                  else if (str_type.Pos("A1"))
                  {
                      str_type = "C1";
                      i_trans_flag = 2;    //SPC_FLG  ¥æ©öÃþ§O
                  }
            }
            //////////////////// END  ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X  ****************/

          ****************************************************************************************************************************************************
	
	
	//³¡ªù±b  2005/10/01
void __fastcall BASIC::SumAllDept(DEPT *dept)

             ////////////////////   ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X   /////////////////////
            str_good_no = Trim(_StringSegment_EX(s, "|", 17));
            if (str_good_no.SubString(1, 1) == "M")  //¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X
                continue;
            //////////////////// END  ¹A·|°Ó«~ CD_FMCODE => M¶}ÀY7½X  ///////////////////

****************************************************************************************************************************************************


	
	//¥»¤é¨Ó«È¼Æ   µLUpdate
	int __fastcall BASIC::SumQt_tcust(int StartLine,int TotalLine)



string __stdcall _Strsprintf(std::string &str, char* format, ...)
{
	char buffer[10240];
	va_list argList;

	va_start(argList, format);
	vsnprintf_s(buffer, sizeof(buffer), format, argList);
	va_end(argList);

	str = string(buffer);
	return(str);
}



///////////////
Start Source Code From XZDATA_Mag20170815



//////////////